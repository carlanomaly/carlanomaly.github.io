<!-- ── Back-to-top button ──────────────────────── -->
<button id="back-to-top" aria-label="Back to top" title="Back to top">
  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
       stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <polyline points="18 15 12 9 6 15"/>
  </svg>
</button>

<script>
// Back-to-top
(function () {
  var btn = document.getElementById('back-to-top');
  if (!btn) return;
  window.addEventListener('scroll', function () {
    btn.classList.toggle('visible', window.scrollY > 300);
  }, { passive: true });
  btn.addEventListener('click', function () {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });
})();

// Scroll-spy TOC (dataset page only)
(function () {
  var nav = document.getElementById('toc-sidebar-nav');
  if (!nav) return;

  var links = nav.querySelectorAll('a');
  var headings = [];
  links.forEach(function (a) {
    var id = a.getAttribute('href').slice(1);
    var el = document.getElementById(id);
    if (el) headings.push({ id: id, el: el, link: a });
  });

  if (!headings.length) return;

  var observer = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        links.forEach(function (a) { a.classList.remove('active'); });
        var match = headings.find(function (h) { return h.el === entry.target; });
        if (match) match.link.classList.add('active');
      }
    });
  }, { rootMargin: '0px 0px -70% 0px', threshold: 0 });

  headings.forEach(function (h) { observer.observe(h.el); });
})();

// Anomaly gallery tabs
(function () {
  var gallery = document.getElementById('anomaly-gallery');
  if (!gallery) return;

  var buttons = gallery.querySelectorAll('.ag-tab-btn');
  var panels = gallery.querySelectorAll('.ag-panel');

  buttons.forEach(function (btn) {
    btn.addEventListener('click', function () {
      var target = btn.getAttribute('data-tab');

      // Pause all videos in current panel
      panels.forEach(function (p) {
        if (!p.classList.contains('ag-hidden')) {
          p.querySelectorAll('video').forEach(function (v) { v.pause(); });
        }
      });

      // Toggle active states
      buttons.forEach(function (b) { b.classList.remove('ag-active'); });
      btn.classList.add('ag-active');

      panels.forEach(function (p) {
        if (p.getAttribute('data-panel') === target) {
          p.classList.remove('ag-hidden');
        } else {
          p.classList.add('ag-hidden');
        }
      });
    });
  });
})();

// Point cloud viewer (dataset page only)
(function () {
  var container = document.querySelector('.pointcloud-viewer');
  if (!container) return;

  var src = container.getAttribute('data-src');
  if (!src) return;

  var canvas = container.querySelector('.pcv-canvas');
  var loading = container.querySelector('.pcv-loading');

  // Class ID to color mapping (CARLA semantic classes)
  var CLASS_COLORS = {
    0:  [0.00, 0.00, 0.00], // Unlabeled
    1:  [0.27, 0.27, 0.27], // Building
    2:  [0.50, 0.25, 0.50], // Fence
    3:  [0.60, 0.60, 0.60], // Other
    4:  [1.00, 0.00, 1.00], // Pedestrian
    5:  [0.40, 0.20, 0.20], // Pole
    6:  [0.90, 0.90, 0.00], // RoadLine
    7:  [0.50, 0.25, 0.50], // Road
    8:  [0.92, 0.78, 0.57], // SideWalk
    9:  [0.42, 0.56, 0.14], // Vegetation
    10: [0.00, 0.00, 0.56], // Vehicles
    11: [0.40, 0.44, 0.47], // Wall
    12: [0.87, 0.87, 0.00], // TrafficSign
    13: [0.74, 0.60, 0.60], // Sky
    14: [0.39, 0.39, 0.39], // Ground
    15: [0.09, 0.09, 0.09], // Bridge
    16: [0.56, 0.00, 0.00], // RailTrack
    17: [0.39, 0.31, 0.31], // GuardRail
    18: [0.94, 0.59, 0.23], // TrafficLight
    19: [0.00, 0.00, 0.35], // Static
    20: [0.86, 0.71, 0.45], // Dynamic
    21: [0.27, 0.40, 0.70], // Water
    22: [0.00, 0.53, 0.22], // Terrain
  };

  function getColor(classId) {
    return CLASS_COLORS[classId] || [0.5, 0.5, 0.5];
  }

  // Dynamically load scripts
  function loadScript(url) {
    return new Promise(function (resolve, reject) {
      var s = document.createElement('script');
      s.src = url;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  var THREE_CDN = 'https://esm.sh/three@0.170.0';
  var ORBIT_CDN = 'https://esm.sh/three@0.170.0/examples/jsm/controls/OrbitControls.js';
  var ARROW_CDN = 'https://esm.sh/apache-arrow@18.0.0';

  // Use dynamic import for ES modules (esm.sh resolves bare specifiers)
  async function init() {
    try {
      var [THREE, OrbitModule, Arrow] = await Promise.all([
        import(THREE_CDN),
        import(ORBIT_CDN),
        import(ARROW_CDN),
      ]);

      var OrbitControls = OrbitModule.OrbitControls;

      // Fetch and parse feather file
      var response = await fetch(src);
      var buffer = await response.arrayBuffer();
      var table = Arrow.tableFromIPC(buffer);

      var xCol = table.getChild('x');
      var yCol = table.getChild('y');
      var zCol = table.getChild('z');
      var classCol = table.getChild('object_tag');
      var numPoints = table.numRows;

      // Build geometry
      var positions = new Float32Array(numPoints * 3);
      var colors = new Float32Array(numPoints * 3);

      for (var i = 0; i < numPoints; i++) {
        positions[i * 3]     = xCol.get(i);
        positions[i * 3 + 1] = zCol.get(i);  // swap y/z for Three.js (y-up)
        positions[i * 3 + 2] = -yCol.get(i);

        var c = getColor(classCol.get(i));
        colors[i * 3]     = c[0];
        colors[i * 3 + 1] = c[1];
        colors[i * 3 + 2] = c[2];
      }

      // Three.js setup
      var width = container.clientWidth;
      var height = container.clientHeight;

      var renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
      renderer.setSize(width, height);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setClearColor(0x1a1f2e);

      var scene = new THREE.Scene();
      var camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 1000);
      camera.position.set(0, 30, 50);

      var controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.1;
      controls.maxDistance = 200;

      var geometry = new THREE.BufferGeometry();
      geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

      var material = new THREE.PointsMaterial({
        size: 0.15,
        vertexColors: true,
        sizeAttenuation: true,
      });

      var points = new THREE.Points(geometry, material);
      scene.add(points);

      // Center on data
      geometry.computeBoundingBox();
      var center = new THREE.Vector3();
      geometry.boundingBox.getCenter(center);
      controls.target.copy(center);
      camera.position.set(center.x, center.y + 30, center.z + 50);
      controls.update();

      // Hide loading
      loading.style.display = 'none';
      canvas.style.display = 'block';

      // Adapt clear color to dark/light mode
      function updateClearColor() {
        var isDark = document.documentElement.classList.contains('dark');
        renderer.setClearColor(isDark ? 0x1a1f2e : 0xf1f5f9);
      }
      updateClearColor();

      var modeObserver = new MutationObserver(updateClearColor);
      modeObserver.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

      // Render loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Handle resize
      var ro = new ResizeObserver(function () {
        var w = container.clientWidth;
        var h = container.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      });
      ro.observe(container);

    } catch (err) {
      console.error('Point cloud viewer error:', err);
      loading.innerHTML = '<span>Failed to load point cloud.</span>';
    }
  }

  init();
})();
</script>
